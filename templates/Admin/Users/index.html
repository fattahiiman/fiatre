{% extends 'Layouts/admin-master.html' %}

{% block title %} Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† {% endblock %}

{% block content %}

    <div class="row">

        {% if messages %}
            {% for item in messages %}
                <script>
                    Swal.fire({
                        title: "ØªØ¨Ø±ÛŒÚ© ! ğŸ¥³",
                        icon: 'success',
                        text: '{{ item }}',
                        type: "success",
                        cancelButtonColor: 'var(--primary)',
                        confirmButtonText: 'Ø§ÙˆÚ©ÛŒ',
                    })
                </script>
            {% endfor %}
        {% endif %}

        <div class="col-lg-12">
            <div class="card-box">
                <div class="card-block">
                    <h4 class="card-title">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h4>

                    {% include 'Admin/search_box.html' with page_obj=page_obj %}

                    <a class="btn btn-primary pull-right" href="{% url 'users-create' %}">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</a>
                    <a class="btn btn-warning pull-right m-l-10" href="{% url 'subscriptions-create' %}">Ø§Ù„Ø­Ø§Ù‚
                        Ø§Ø´ØªØ±Ø§Ú©</a>

                    {% include 'Admin/Users/partials/list.html' with page_obj=page_obj users=users %}

                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block Scripts %}
    <script>
        var search_word = ''
        var current_page = 1
        var current_limit = 10

        // CSRF TOKEN //
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////

        // Confirms //

        function DeleteConfirm(phone, item_id, is_last_item) {
            Swal.fire({
                title: "Ù‡Ø´Ø¯Ø§Ø± ! ",
                icon: 'warning',
                text: "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù  Ú©Ø§Ø±Ø¨Ø± ( " + phone + " ) Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ ØŸ ğŸ¤”",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: '#00aced',
                cancelButtonColor: '#e6294b',
                confirmButtonText: 'Ø­Ø°Ù',
                cancelButtonText: 'Ø§Ù†ØµØ±Ø§Ù'
            }).then((result) => {
                if (result.isConfirmed) {
                    Delete(item_id, is_last_item)
                }
            })
        }

        function DeleteSubscriptionConfirm(phone, item_id) {
            Swal.fire({
                title: "Ù‡Ø´Ø¯Ø§Ø± ! ",
                icon: 'warning',
                text: "Ø¢ÛŒØ§ Ø§Ø² Ø³Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ú©  Ú©Ø§Ø±Ø¨Ø± ( " + phone + " ) Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ ØŸ ğŸ¤”",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: '#00aced',
                cancelButtonColor: '#e6294b',
                confirmButtonText: 'Ø³Ù„Ø¨',
                cancelButtonText: 'Ø§Ù†ØµØ±Ø§Ù'
            }).then((result) => {
                if (result.isConfirmed) {
                    DeleteSubscription(item_id)
                }
            })
        }

        //////////////////////////////////////////////////////////////////////////////////

        function Paginate(page = 1) {
            $.ajax({
                url: "{% url 'users' %}?page=" + page + '&search=' + search_word + '&limit=' + limit,
                method: "GET",
                async: true,
                success: function (data) {
                    $("#list").html(data)
                    current_page = page
                },
            });
        }

        function Search() {
            var search = $('#search').val()

            current_page = 1

            $.ajax({
                url: "{% url 'users' %}?page=" + current_page + '&search=' + search + '&limit=' + limit,
                method: "GET",
                async: true,
                success: function (data) {
                    $("#list").html(data)
                    search_word = search
                },
            });
        }

        function Limit() {
            var limit = parseInt($("#limit option:selected").val())
            current_page = 1

            $.ajax({
                url: "{% url 'users' %}?page=" + current_page + '&search=' + search_word + '&limit=' + limit,
                method: "GET",
                async: true,
                success: function (data) {
                    $("#list").html(data)
                    current_limit = limit
                },
            });
        }

        function Delete(item_id, is_last_item) {

            const csrftoken = getCookie('csrftoken');

            if (is_last_item === 'yes') {
                if (current_page !== 1) {
                    current_page = current_page - 1
                }
            }

            $.ajax({
                url: "/admin/users/delete/" + item_id + '/',
                headers: {'X-CSRFToken': csrftoken},
                method: "DELETE",
                async: true,
                success: function (data) {

                    if (data['status'] === 'OK') {

                        $.ajax({
                            url: "{% url 'users' %}?page=" + current_page + '&search=' + search_word + '&limit=' + current_limit,
                            method: "GET",
                            async: true,
                            success: function (data) {
                                $("#list").html(data)
                                Swal.fire({
                                    title: "ØªØ¨Ø±ÛŒÚ© ! ğŸ¥³",
                                    icon: 'success',
                                    text: 'Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.',
                                    type: "success",
                                    cancelButtonColor: 'var(--primary)',
                                    confirmButtonText: 'Ø§ÙˆÚ©ÛŒ',
                                })
                            },
                        });

                    }

                },
            });

        }

        function DeleteSubscription(item_id) {

            const csrftoken = getCookie('csrftoken');

            $.ajax({
                url: "/admin/subscriptions/delete/" + item_id + '/',
                headers: {'X-CSRFToken': csrftoken},
                method: "DELETE",
                data: {'current_page': current_page},
                async: true,
                success: function (data) {

                    if (data['status'] === 'OK') {

                        $.ajax({
                            url: "{% url 'users' %}?page=" + current_page + '&search=' + search_word + '&limit=' + current_limit,
                            method: "GET",
                            async: true,
                            success: function (data) {
                                $("#list").html(data)
                                Swal.fire({
                                    title: "ØªØ¨Ø±ÛŒÚ© ! ğŸ¥³",
                                    icon: 'success',
                                    text: 'Ø³Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ú© Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.',
                                    type: "success",
                                    cancelButtonColor: 'var(--primary)',
                                    confirmButtonText: 'Ø§ÙˆÚ©ÛŒ',
                                })
                            },
                        });

                    }

                },
            });
        }

    </script>
{% endblock %}